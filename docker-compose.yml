version: '3'
services:
  # This is capible to relay via gmail, Amazon SES, or generic relays
  # See: https://hub.docker.com/r/namshi/smtp
  mail:
    image: namshi/smtp

  redis:
    image: redis:latest
    command: --requirepass The_minimum_password_length_is_32_characters
    restart: always
    read_only: true
    volumes:
      - misp_redis:/data

  clamav:
    image: clamav/clamav:latest
    restart: always
    read_only: true
    volumes:
      - misp_clamdb:/var/lib/clamav
    tmpfs:
      - /run
      - /tmp
      - /var/lock
      - /var/log/clamav

  db:
    image: mysql:latest
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    read_only: true
    cap_add:
      - SYS_NICE
    environment:
      - "MYSQL_USER=misp"
      - "MYSQL_PASSWORD=The_minimum_password_length_is_17_characters"
      - "MYSQL_ROOT_PASSWORD=Very_Long_&_Secure_Root_Password"
      - "MYSQL_DATABASE=misp"
    tmpfs:
      - /run/mysqld
      - /tmp
    volumes:
      - misp_db:/var/lib/mysql

  misp-modules:
    image: epuzanov/misp-modules:latest
    restart: always
    read_only: true
    build:
        context: modules/.
        args:
            - MODULES_TAG=${MODULES_TAG}
    environment:
      - "REDIS_BACKEND=redis"
      - "REDIS_PW=The_minimum_password_length_is_32_characters"
      - "REDIS_DATABASE=245"
    depends_on:
      - redis
      - db
    tmpfs:
      - /run
      - /tmp

  misp:
    image: epuzanov/misp-fpm:latest
    restart: always
    read_only: true
    build:
        context: misp/.
        args:
            - MISP_TAG=${MISP_TAG}
            - PHP_API=${PHP_API}
            - PHP_VER=${PHP_VER}
    depends_on:
      - redis
      - db
      - misp-modules
    tmpfs:
      - /run
      - /tmp
    volumes:
      - misp_conf:/var/www/MISP/app/Config
      - misp_files:/var/www/MISP/app/files
      - misp_tmp:/var/www/MISP/app/tmp
    environment:
      - "MISP_BASEURL=https://localhost"
      - "REDIS_FQDN=redis"
      - "REDIS_PASSWORD=The_minimum_password_length_is_32_characters"
#      - "GPG_REAL_NAME=Autogenerated Key"
#      - "GPG_COMMENT=WARNING: MISP AutoGenerated Key consider this Key VOID!"
#      - "GPG_EMAIL_ADDRESS=admin@admin.test"
#      - "MYSQL_HOST=db"
#      - "MYSQL_USER=misp"
#      - "MYSQL_PASSWORD=The_minimum_password_length_is_17_characters"
#      - "MYSQL_DATABASE=misp"

  cron:
    image: epuzanov/misp-fpm:latest
    restart: always
    read_only: true
    depends_on:
      - misp
    tmpfs:
      - /run
      - /tmp
      - /var/spool/cron
    volumes:
      - misp_conf:/var/www/MISP/app/Config
      - misp_files:/var/www/MISP/app/files
      - misp_tmp:/var/www/MISP/app/tmp
#      - misp_cron:/etc/cron.d
    environment:
      - "CRON=true" # Start CRON
      - "FPM=false" # Do not start FPM and workers

  web:
    image: epuzanov/misp-web:latest
    restart: always
    read_only: true
    build:
        context: web/.
    tmpfs:
      - /run
      - /var/cache/nginx
    volumes:
      - misp_certs:/etc/nginx/certs
      - misp_files:/var/www/MISP/app/files
    depends_on:
      - misp
    ports:
      - 80:80
      - 443:443

volumes:
    misp_db:
    misp_redis:
    misp_clamdb:
    misp_conf:
#    misp_cron:
    misp_files:
    misp_tmp:
    misp_certs:
